<html>
    <head>
        <title>XWork - 
        ExpressionValidator Tips
         </title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <h2><a name="ExpressionValidatorTips-ExpressionValidatorTips"></a>ExpressionValidator Tips</h2>

<h3><a name="ExpressionValidatorTips-Fieldnamereferences"></a>Fieldname references</h3>
<p>As long as your Action provides a "setter" and a "getter" for your form fields, you can simply refer to them in your expression by name.</p>

<p>Given this form field:</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;input type=text name=<span class="code-quote">"foo"</span>&gt;</span></pre>
</div></div>

<p>And this Action fragment</p>

<div class="code"><div class="codeContent">
<pre class="code-java"><span class="code-keyword">private</span> <span class="code-object">String</span> foo;
<span class="code-keyword">public</span> void setFoo(<span class="code-object">String</span> Foo) { <span class="code-keyword">this</span>.foo = foo; }
<span class="code-keyword">public</span> <span class="code-object">String</span> getFoo() {<span class="code-keyword">return</span> foo; }</pre>
</div></div>

<p>Your form fields are available to your expression like this:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">foo == <span class="code-quote">"sometext"</span></pre>
</div></div>


<h3><a name="ExpressionValidatorTips-Advancedfieldreferences"></a>Advanced field references</h3>
<p>If you expose an object in your Action via a getter, you can directly set (from the form) and access (from the validation expression) properties <b>within</b> that object.</p>

<p>Given this form fragment:</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;input type=text name=<span class="code-quote">"address.firstName"</span>&gt;</span>
<span class="code-tag">&lt;input type=text name=<span class="code-quote">"address.lastName"</span>&gt;</span></pre>
</div></div>

<p>And this Action fragment:</p>

<div class="code"><div class="codeContent">
<pre class="code-java"><span class="code-keyword">private</span> Address address;
<span class="code-keyword">public</span> void setAddress(Address address) { <span class="code-keyword">this</span>.address = address; }
<span class="code-keyword">public</span> Address getAddress() {<span class="code-keyword">return</span> address; }</pre>
</div></div>

<p>Your validation expression can do this:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">address.firstName == <span class="code-quote">"Joe"</span> and address.lastName == <span class="code-quote">"Bloe"</span></pre>
</div></div>

<table cellpadding='5' width='85%' cellspacing='8px' class='noteMacro' border="0" align='center'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="/images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>
<p>Some use this feature to expose their "model" or "domain" objects directly to their forms and to their validation code.</p>

<p>This can be incredibly powerful but should be used with caution as it allows anybody monkey-ing with URL's (or custom forms) to inject data directly into your domain objects that you might not want to have there.</p>

<p>Jason said it well: "It's a great tool, but it's a sharp tool, and you can cut yourself with it."</p></td></tr></table>


<h3><a name="ExpressionValidatorTips-ExpressionValidatorsuseOGNL"></a>ExpressionValidators use OGNL</h3>
<p>OGNL: Pronounced like the "ogonal" part of orthogonal.</p>

<p>The ExpressionValidator expressions are simply OGNL expressions that evaluate to true or false.  You have the complete OGNL language and stack available to you when writing ExpressionValidator expressions.</p>

<p>For most of what you probably want to do, you don't need to worry about all that.  Just reference your fields by name, use standard comparison operators, etc.</p>

<p>But if you want the full meal deal there is a huge amount of power (and complexity) available if you want to take the time to plumb the depths of OGNL.  The OGNL docs are here:</p>

<p><a href="http://www.ognl.org/" title="Visit page outside Confluence">&#104;ttp://www.ognl.org/</a></p>


<h3><a name="ExpressionValidatorTips-Falseexpressionstriggerthevalidationerror"></a>False expressions trigger the validation error</h3>

<p>I often find myself thinking of my validation tests exactly opposite of how WebWork thinks of them.</p>

<p>If you want to trigger a validation error if two fields are inequal, you might be inclined to do this:</p>

<div class="code"><div class="codeHeader"><b>Probably not what you want!</b></div><div class="codeContent">
<pre class="code-java">email != emailVerified</pre>
</div></div>

<p>That will do exactly the opposite of what you expect.  It will return "false" when the fields are equal (and trigger a validation error) and "true" when the fields are not equal (not triggering a validation error).</p>

<p>You want to do this:</p>

<div class="code"><div class="codeHeader"><b>Probably what you want</b></div><div class="codeContent">
<pre class="code-java">email == emailVerified</pre>
</div></div>

<p>If your brain works like mine, you'll probably end up negating a lot of your expressions.  If you have long or compound expressions that evaluate to true, just wrap the whole thing in parenthesis to negate it:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">!
(
  ( chosenAddressId.intValue() eq -1 )
  and
  ( regionId.intValue() eq -1 )
  and
  ( ( countryId.intValue() eq 1 ) or ( countryId.intValue() eq 2 ) )
)</pre>
</div></div>


<h3><a name="ExpressionValidatorTips-Expressioncanbemultiline"></a>Expression can be multi-line</h3>
<p>As you can see above, your expression can span as many lines as you like.  This really helps keep complex expressions readable.</p>


<h3><a name="ExpressionValidatorTips-Usethevalidationmessagefordebugging"></a>Use the validation message for debugging</h3>
<p>A common mistake is to incorrectly refer to the field you want to compare.  You can verify that the field you <b>think</b> you're referring to is the field you're <b>actually</b> referring to by creating an ExpressionValidator that always returns false (meaning that it always triggers a validation error), and emitting the field values in its message like so:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">&lt;field name=<span class="code-quote">"user.password_confirm"</span>&gt;
  &lt;field-validator type=<span class="code-quote">"fieldexpression"</span>&gt;
    &lt;param name=<span class="code-quote">"expression"</span>&gt;<span class="code-keyword">false</span>&lt;/param&gt;
    &lt;message&gt;${password}   ${password_verified}&lt;/message&gt;
  &lt;/field-validator&gt;
&lt;/field&gt;</pre>
</div></div>


<h3><a name="ExpressionValidatorTips-SpecialhandlingofnullandStringequality"></a>Special handling of null and String equality</h3>

<p><b>nulls</b><br/>
The comparison operators used by the ExpressionValidator will internally handle nulls and, generally, "do the right thing" with regard to comparisons containing fields with null values.  Recall that in java you might be inclined to write a test like so...</p>

<div class="code"><div class="codeHeader"><b>What you'd do in Java</b></div><div class="codeContent">
<pre class="code-java"><span class="code-keyword">if</span>( field != <span class="code-keyword">null</span> &amp;&amp; field.intValue() == 2 )</pre>
</div></div>

<p>...to ensure your field wasn't null so you avoid a potential null-pointer exception in the rest of the test.  This is unnecessary in OGNL, simply do this:</p>

<div class="code"><div class="codeHeader"><b>What you do in an ExpressionValidator</b></div><div class="codeContent">
<pre class="code-java">field.intValue() == 2</pre>
</div></div>

<p><b>Strings</b><br/>
There is also  no need to do .equals() comparisons on strings.  Recall that in Java you usually do not compare two strings with the == operator, you use the .equals() method of your String object instead.  But the OGNL expression language will automatically do a .equals() comparison for you when you use the == operator on two Strings.</p>

<p>These two are equivalent:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">password.equals(passwordVerified)</pre>
</div></div>

<p>... is equivalent to ...</p>

<div class="code"><div class="codeContent">
<pre class="code-java">password == passwordVerified</pre>
</div></div>

<p><b>From the OGNL docs:</b></p>
<blockquote>
<p><em>Equality is tested for as follows. If either value is null, they are equal if and only if both are null. If they are the same object or the equals() method says they are equal, they are equal. If they are both Numbers, they are equal if their values as double-precision floating point numbers are equal. Otherwise, they are not equal. These rules make numbers compare equal more readily than they would normally, if just using the equals method.</em></p></blockquote>


<h3><a name="ExpressionValidatorTips-FieldValidatorsdonotshortcircuitExpressionValidators."></a>FieldValidators do not short-circuit ExpressionValidators.</h3>

<p>Ever.</p>

<p>See the docs (currently only available on the Wiki docs) for information about short-circuiting:</p>

<p>  <a href="http://wiki.opensymphony.com/display/XW/Validation+Framework" title="Visit page outside Confluence">&#104;ttp://wiki.opensymphony.com/display/XW/Validation+Framework</a></p>

<p>The upshot is that a FieldValidator (regardless of whether you use the &lt;validator&gt; or &lt;field-validator&gt; syntax) will <b>never</b> short-circuit an ExpressionValidator.  And since most of the built-in validators are FieldValidators, you probably will not get the short-circuit behavior you want by mixing FieldValidators and Expressionvalidators.</p>

<p>Given this example...</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;validator type=<span class="code-quote">"required"</span> short-circuit=<span class="code-quote">"true"</span>&gt;</span>
    <span class="code-tag">&lt;param name=<span class="code-quote">"fieldName"</span>&gt;</span>bar<span class="code-tag">&lt;/param&gt;</span>
    <span class="code-tag">&lt;message&gt;</span>You must enter a value for bar.<span class="code-tag">&lt;/message&gt;</span>
<span class="code-tag">&lt;/validator&gt;</span>

<span class="code-tag">&lt;validator type=<span class="code-quote">"expression"</span>&gt;</span>
    <span class="code-tag">&lt;param name=<span class="code-quote">"expression"</span>&gt;</span>foo gt bar<span class="code-tag">&lt;/param&gt;</span>
    <span class="code-tag">&lt;message&gt;</span>foo must be great than bar.<span class="code-tag">&lt;/message&gt;</span>
<span class="code-tag">&lt;/validator&gt;</span></pre>
</div></div>

<p>...the ExpresionValidator will <b>always</b> run.</p>

<p>If you find yourself needing to short-circuit a FieldValidator you can always create an ExpressionValidator that does the equivalent work of the FieldValidator.  Once your validation check is implemented as an ExpressionValidator it will be short-circuited by other validators.</p>


<h3><a name="ExpressionValidatorTips-ExpressionValidatorsdoshortcircuitFieldValidators."></a>ExpressionValidators do short-circuit FieldValidators.</h3>

<p>An ExpressionValidator <b>will</b> short-circuit FieldValidators.</p>

<p>If we rewrite the above example to place the short-circuit on the ExpressionValidator...</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;validator type=<span class="code-quote">"required"</span>&gt;</span>
    <span class="code-tag">&lt;param name=<span class="code-quote">"fieldName"</span>&gt;</span>bar<span class="code-tag">&lt;/param&gt;</span>
    <span class="code-tag">&lt;message&gt;</span>You must enter a value for bar.<span class="code-tag">&lt;/message&gt;</span>
<span class="code-tag">&lt;/validator&gt;</span>

<span class="code-tag">&lt;validator type=<span class="code-quote">"expression"</span> short-circuit=<span class="code-quote">"true"</span>&gt;</span>
    <span class="code-tag">&lt;param name=<span class="code-quote">"expression"</span>&gt;</span>foo gt bar<span class="code-tag">&lt;/param&gt;</span>
    <span class="code-tag">&lt;message&gt;</span>foo must be great than bar.<span class="code-tag">&lt;/message&gt;</span>
<span class="code-tag">&lt;/validator&gt;</span></pre>
</div></div>

<p>... we get behavior wherein a validation error by the ExpressionValidator will cause the "required" FieldValidator to be skipped.</p>


<h3><a name="ExpressionValidatorTips-TurnonXMLreloading"></a>Turn on XML reloading</h3>
<p>During development/debugging of expressions, it can be immensely helpful to turn on XML reloading.  This will allow your changes to the -validation.xml files be noticed by WebWork without a restart.</p>

<p>In webwork.properties set...</p>

<div class="code"><div class="codeContent">
<pre class="code-java">webwork.configuration.xml.reload = <span class="code-keyword">true</span></pre>
</div></div>

<p>See the docs about the webwork.properties file and where it should be placed.</p>

<table cellpadding='5' width='85%' cellspacing='8px' class='noteMacro' border="0" align='center'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="/images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>
<p>Note that if your development environment has you editing your "main" code files in one place and then copying them into your app-server for deployment <em>xml.reload</em> only reloads the <b>deployed</b> copies.</p>

<p>That's a no-duh, but it's easy to forget in IDE's like NetBeans.  NetBeans maintains the "main" code in a separate directory from the code actually used by the deployed app (which it locates in the build directory).</p>

<p>If this is the case with your dev environment, no worries, just edit the <b>deployed</b> -validation.xml file while you're developing and debugging and then copy the final changes back to your "main" file when you're done.</p>

<p><font color="red">Be sure to copy those changes back to your main file before you rebuild!!</font></p></td></tr></table>

<h3><a name="ExpressionValidatorTips-Letterbasedcomparisonoperatorsareyourfriends"></a>Letter-based comparison operators are your friends</h3>

<p><b>the problem</b><br/>
Many of the normal comparison operators cannot be used un-escaped in your XML validation file. For example, you can't use an expression like this...</p>

<div class="code"><div class="codeHeader"><b>Won't work</b></div><div class="codeContent">
<pre class="code-java">field &gt; 2</pre>
</div></div>

<p>...because the greater-than sign has special meaning in XML.</p>

<p><b>the solution</b><br/>
Some would suggest you escape the greater-than sign like this:</p>

<div class="code"><div class="codeHeader"><b>This will work</b></div><div class="codeContent">
<pre class="code-java">field &amp;amp;gt; 2</pre>
</div></div>

<p>Others have suggested that you use a CDATA block like this (note, I have not personally tried this):</p>

<div class="code"><div class="codeHeader"><b>This will also work</b></div><div class="codeContent">
<pre class="code-java">&lt;![CDATA[ field &gt; 2 ]]&gt;</pre>
</div></div>

<p>But I find both of those rather ugly.  The easier thing to do is to just remember that all of the OGNL comparison operators have letter-based notations.  So the above (within an ExpressionValidator) works perfectly well:</p>

<div class="code"><div class="codeHeader"><b>This will work, and look how pretty it is</b></div><div class="codeContent">
<pre class="code-java">field gt 2</pre>
</div></div>

<p>The letter-based notation for each of the OGNL comparison operators can be found in this section of the OGNL docs:</p>

<p><a href="http://www.ognl.org/2.6.7/Documentation/html/LanguageGuide/apa.html#operators" title="Visit page outside Confluence">&#104;ttp://www.ognl.org/2.6.7/Documentation/html/LanguageGuide/apa.html#operators</a></p>

<p>I've gotten into the habit of using letter-based operator syntax for all my OGNL comparison operators whether they need to be escaped or not.  Keeps my brain in the "OGNL" groove (and helps remind this is <b>not</b> java and that there are some subtle differences such as the null and String handling noted above).</p>

<table cellpadding='5' width='85%' cellspacing='8px' class='noteMacro' border="0" align='center'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="/images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>OGNL's letter-based comparison operators feel comfortingly perl-ish.  But remember that OGNL's letter-based comparison operators work on <b>all</b> datatypes, unlike perl where the letter-based comparison operators work only on strings.</td></tr></table>

                    			    </td>
		    </tr>
	    </table>
    </body>
</html>
