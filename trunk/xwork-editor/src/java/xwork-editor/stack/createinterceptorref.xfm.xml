<xface:window
	xmlns:xface="http://www.xesoft.com/xmlns/xface"
	xmlns:xprocess="http://www.xesoft.com/xmlns/xprocess"
	id="create_interceptor_ref"
	width="400"
	height="400"
	location="center_on_screen"
	modal="application">

	<xface:relative-layout constraints="/xwork-editor/select.layout.xml" />

	<xface:multi-line-label id="label_message" label="create_interceptor_ref_message" />

	<xface:list id="list">
		<xface:xml-tablemodel id="model" xpath="*[self::interceptor-stack or self::interceptor]"/>
		<xface:column id="name" property="@name">
			<xface:script-decision id="imageDecision">
				<xface:param id="script"><![CDATA[
					function chooseParameterImage(aObject)
					{
						var vName = aObject.getLocalName();

						if (vName.equals("interceptor"))
						{
							return "xwork-editor/images/interceptor.gif";
						}
						else
						{
							return "xwork-editor/images/interceptor_stack.gif";
						}
					}

					chooseParameterImage(object);
			]]></xface:param>
			</xface:script-decision>
		</xface:column>
	</xface:list>

	<xface:panel id="inputs">
		<xface:input-panel-layout />

		<xface:label id="label_name" label="name" />
		<xface:text-input id="name" />

	</xface:panel>

	<xface:button id="ok" label="ok" />
	<xface:button id="cancel" label="cancel" />

	<!-- Hide the window when cancel is pressed -->
	<xface:hide-adapter element="../cancel" event="ACTION" />

	<!-- Show the window when add_package button is pressed -->
	<xface:show-adapter element="../../toolbar/create_interceptor_ref" event="ACTION" />

	<!-- Clear the inputs when the window is shown -->
	<xprocess:action>
		<xface:action-adapter element="../.." event="SHOW" />
		<xprocess:script>
			<xface:param id="script"><![CDATA[
				parent.findElement("../inputs/name").setValue("");

				var vModel = parent.findElement("../../table/model");
				var vRoot = vModel.getData();

				parent.findElement("../list/model").setData(vRoot.getParentNode());
			]]></xface:param>
		</xprocess:script>
	</xprocess:action>

	<!-- Create the package when the OK button is pressed -->
	<xprocess:action>
		<xface:action-adapter element="../../ok" event="ACTION" />
		<xprocess:script>
			<xface:param id="script"><![CDATA[
				var vName = parent.findElement("../inputs/name").getValue();
				var vModel = parent.findElement("../../table/model");
				var vRoot = vModel.getData();
				var vDocument = vRoot.getOwnerDocument();

				/* First check to see that a real package name was entered */
				if (vName.trim().length() == 0)
				{
					throw "A valid name was not entered";
				}

				/* Second check to see if the interceptor stack (or interceptor) exists */
				var vExistingElement = Packages.com.xe.xface.xml.XPathGetter.getElement(vRoot,"interceptor-ref[@name='"+vName+"']");
				if (vExistingElement != null)
				{
					throw "A reference to the interceptor '"+vName+"' already exists";
				}

				/* Now, create the element and add it to the model */
				var vElement = vDocument.createElement("interceptor-ref");
				vElement.setAttribute("name",vName);
				vModel.addObject(vElement);
			]]></xface:param>
		</xprocess:script>
		<xprocess:hide object="../.." />
	</xprocess:action>

	<xprocess:action>
		<xface:action-adapter element="../../list" event="SELECT_ROW" />
		<xprocess:script>
			<xface:input id="row" type="variable" value="arg0" />
			<xface:param id="script"><![CDATA[
			   var vList = parent.findElement("../list");
				var vName = vList.getModel().getPropertyAsString(row,"@name");
				parent.findElement("../inputs/name").setValue(vName);
			]]></xface:param>
		</xprocess:script>
	</xprocess:action>

</xface:window>